rxPermissive({
    context("Parameter and Data translation")
    test_that("named par and single event table", {

        mod <- RxODE({
            a = 6
            b = 0.6
            d/dt(intestine) = -a*intestine
            d/dt(blood)     = a*intestine - b*blood
        })

        et <- eventTable(time.units="days")
        et$add.sampling(seq(0,10,by=1/24))
        et$add.dosing(dose=2/24,rate=2,strt.time=0,
                      nbr.doses=10,dosing.interval=1)

        tmp2 <- rxDataParSetup(mod, et);
        expect_equal(class(tmp2), c("RxODE.par.data", "RxODE.multi.data"));
        expect_equal(tmp2$pars, c(6, 0.6))
        expect_equal(tmp2$nsim, 1L)
        expect_equal(tmp2$n.pars, 2L)
        expect_equal(tmp2$inits, structure(c(0, 0), .Names = c("intestine", "blood")));

        ## Now try numeric vector setup
        tmp2 <- rxDataParSetup(mod, et, c(a=60));
        expect_equal(tmp2$pars, c(60, 0.6))

        tmp2 <- rxDataParSetup(mod, c(a=60), et);
        expect_equal(tmp2$pars, c(60, 0.6))


        tmp2 <- rxDataParSetup(mod, et, c(b=60));
        expect_equal(tmp2$pars, c(6, 60))

        tmp2 <- rxDataParSetup(mod, c(b=60), et);
        expect_equal(tmp2$pars, c(6, 60))

        ## Now try parameters that don't exist
        tmp2 <- rxDataParSetup(mod, et, c(c=60));
        expect_equal(tmp2$pars, c(6, 0.6))

        tmp2 <- rxDataParSetup(mod, c(c=60), et);
        expect_equal(tmp2$pars, c(6, 0.6))

        ## Now do a data frame.
        tmp2 <- rxDataParSetup(mod, data.frame(a=c(6, 7), b=c(8, 9)), et);
        expect_equal(tmp2$pars, c(6, 8, 7, 9))

        tmp2 <- rxDataParSetup(mod, data.frame(a=c(6, 7, 8), b=c(8, 9, 10)), et);
        expect_equal(tmp2$pars, c(6, 8, 7, 9, 8, 10))

        tmp2 <- rxDataParSetup(mod, et, data.frame(a=c(6, 7, 8), b=c(8, 9, 10)));
        expect_equal(tmp2$pars, c(6, 8, 7, 9, 8, 10))

        tmp2 <- rxDataParSetup(mod, et, data.frame(a=c(6, 7, 8)));
        expect_equal(tmp2$pars, c(6, 0.6, 7, 0.6, 8, 0.6))

        tmp2 <- rxDataParSetup(mod, et, data.frame(b=c(6, 7, 8)));
        expect_equal(tmp2$pars, c(6, 6, 6, 7, 6, 8))

        tmp2 <- rxDataParSetup(mod, et, data.frame(c=c(6, 7, 8)));
        expect_equal(tmp2$pars, c(6, 0.6, 6, 0.6, 6, 0.6))

        ## Now matrices
        tmp2 <- rxDataParSetup(mod, as.matrix(data.frame(a=c(6, 7), b=c(8, 9))), et);
        expect_equal(tmp2$pars, c(6, 8, 7, 9))

        tmp2 <- rxDataParSetup(mod, as.matrix(data.frame(a=c(6, 7, 8), b=c(8, 9, 10))), et);
        expect_equal(tmp2$pars, c(6, 8, 7, 9, 8, 10))

        tmp2 <- rxDataParSetup(mod, et, as.matrix(data.frame(a=c(6, 7, 8), b=c(8, 9, 10))));
        expect_equal(tmp2$pars, c(6, 8, 7, 9, 8, 10))

        tmp2 <- rxDataParSetup(mod, et, as.matrix(data.frame(a=c(6, 7, 8))));
        expect_equal(tmp2$pars, c(6, 0.6, 7, 0.6, 8, 0.6))

        tmp2 <- rxDataParSetup(mod, et, as.matrix(data.frame(b=c(6, 7, 8))));
        expect_equal(tmp2$pars, c(6, 6, 6, 7, 6, 8))

        tmp2 <- rxDataParSetup(mod, et, as.matrix(data.frame(c=c(6, 7, 8))));
        expect_equal(tmp2$pars, c(6, 0.6, 6, 0.6, 6, 0.6))
    })

    test_that("named par and single event table", {

        mod <- RxODE({
            a = 6
            b = 0.6
            d/dt(intestine) = -a*intestine
            d/dt(blood)     = a*intestine - b*blood
        })

        if (file.exists("test-data-setup.Rdata")){
            load("test-data-setup.Rdata")
        } else {
            tmp <- try(devtools::package_file("tests/testthat/test-data-setup.Rdata"));
            if (!inherits(tmp, "try-error") && file.exists(tmp)){
                load(tmp)
            } else {
                skip("Can't load test dataset.")
            }
        }

        pv <- c(2, 0.6, 2.48739495798319, 0.897478991596639, 2.97478991596639, 1.19495798319328, 3.46218487394958, 1.49243697478992, 3.94957983193277, 1.78991596638655, 4.43697478991597, 2.08739495798319, 4.92436974789916, 2.38487394957983, 5.41176470588235, 2.68235294117647, 5.89915966386555, 2.97983193277311, 6.38655462184874, 3.27731092436975, 6.87394957983193, 3.57478991596639, 7.36134453781513, 3.87226890756303, 7.84873949579832, 4.16974789915966, 8.33613445378151, 4.4672268907563, 8.82352941176471, 4.76470588235294, 9.3109243697479, 5.06218487394958, 9.79831932773109, 5.35966386554622, 10.2857142857143, 5.65714285714286, 10.7731092436975, 5.9546218487395, 11.2605042016807, 6.25210084033613, 11.7478991596639, 6.54957983193277, 12.2352941176471, 6.84705882352941, 12.7226890756303, 7.14453781512605, 13.2100840336134, 7.44201680672269, 13.6974789915966, 7.73949579831933, 14.1848739495798, 8.03697478991597, 14.672268907563, 8.33445378151261, 15.1596638655462, 8.63193277310924, 15.6470588235294, 8.92941176470588, 16.1344537815126, 9.22689075630252, 16.6218487394958, 9.52436974789916, 17.109243697479, 9.8218487394958, 17.5966386554622, 10.1193277310924, 18.0840336134454, 10.4168067226891, 18.5714285714286, 10.7142857142857, 19.0588235294118, 11.0117647058824, 19.546218487395, 11.309243697479, 20.0336134453782, 11.6067226890756, 20.5210084033613, 11.9042016806723, 21.0084033613445, 12.2016806722689, 21.4957983193277, 12.4991596638655, 21.9831932773109, 12.7966386554622, 22.4705882352941, 13.0941176470588, 22.9579831932773, 13.3915966386555, 23.4453781512605, 13.6890756302521, 23.9327731092437, 13.9865546218487, 24.4201680672269, 14.2840336134454, 24.9075630252101, 14.581512605042, 25.3949579831933, 14.8789915966387, 25.8823529411765, 15.1764705882353, 26.3697478991597, 15.4739495798319, 26.8571428571429, 15.7714285714286, 27.344537815126, 16.0689075630252, 27.8319327731092, 16.3663865546218, 28.3193277310924, 16.6638655462185, 28.8067226890756, 16.9613445378151, 29.2941176470588, 17.2588235294118, 29.781512605042, 17.5563025210084, 30.2689075630252, 17.853781512605, 30.7563025210084, 18.1512605042017, 31.2436974789916, 18.4487394957983, 31.7310924369748, 18.746218487395, 32.218487394958, 19.0436974789916, 32.7058823529412, 19.3411764705882, 33.1932773109244, 19.6386554621849, 33.6806722689076, 19.9361344537815, 34.1680672268908, 20.2336134453782, 34.6554621848739, 20.5310924369748, 35.1428571428571, 20.8285714285714, 35.6302521008403, 21.1260504201681, 36.1176470588235, 21.4235294117647, 36.6050420168067, 21.7210084033613, 37.0924369747899, 22.018487394958, 37.5798319327731, 22.3159663865546, 38.0672268907563, 22.6134453781513, 38.5546218487395, 22.9109243697479, 39.0420168067227, 23.2084033613445, 39.5294117647059, 23.5058823529412, 40.0168067226891, 23.8033613445378, 40.5042016806723, 24.1008403361345, 40.9915966386555, 24.3983193277311, 41.4789915966387, 24.6957983193277, 41.9663865546218, 24.9932773109244, 42.453781512605, 25.290756302521, 42.9411764705882, 25.5882352941176, 43.4285714285714, 25.8857142857143, 43.9159663865546, 26.1831932773109, 44.4033613445378, 26.4806722689076, 44.890756302521, 26.7781512605042, 45.3781512605042, 27.0756302521008, 45.8655462184874, 27.3731092436975, 46.3529411764706, 27.6705882352941, 46.8403361344538, 27.9680672268908, 47.327731092437, 28.2655462184874, 47.8151260504202, 28.563025210084, 48.3025210084034, 28.8605042016807, 48.7899159663866, 29.1579831932773, 49.2773109243697, 29.455462184874, 49.7647058823529, 29.7529411764706, 50.2521008403361, 30.0504201680672, 50.7394957983193, 30.3478991596639, 51.2268907563025, 30.6453781512605, 51.7142857142857, 30.9428571428571, 52.2016806722689, 31.2403361344538, 52.6890756302521, 31.5378151260504, 53.1764705882353, 31.8352941176471, 53.6638655462185, 32.1327731092437, 54.1512605042017, 32.4302521008403, 54.6386554621849, 32.727731092437, 55.1260504201681, 33.0252100840336, 55.6134453781513, 33.3226890756303, 56.1008403361345, 33.6201680672269, 56.5882352941176, 33.9176470588235, 57.0756302521008, 34.2151260504202, 57.563025210084, 34.5126050420168, 58.0504201680672, 34.8100840336134, 58.5378151260504, 35.1075630252101, 59.0252100840336, 35.4050420168067, 59.5126050420168, 35.7025210084034, 60, 36);

        tmp2 <- rxDataParSetup(mod, dat,
                               data.frame(a=seq(2, 60, length.out=120),
                                          b=seq(0.6, 36, length.out=120)));

        expect_equal(tmp2$pars, pv);

        tmp2 <- rxDataParSetup(mod, dat,
                               data.frame(b=seq(0.6, 36, length.out=120),
                                          a=seq(2, 60, length.out=120)))

        expect_equal(tmp2$pars, pv);


    })
}, cran=FALSE)
