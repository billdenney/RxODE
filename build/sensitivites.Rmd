---
title: "Sensitivities in ADVAN solutions"
output: html_notebook
---

# Helper functions

```{r}
toC <- function(x) {
  s <- rxS(x)
  funReg <- rex::rex(capture(or(get(".fun",globalenv()))))
  extra <- paste0("(",paste(get(".args", globalenv()), collapse = ","),")")
  funReg2 <- rex::rex(capture(funReg),"(",except_any_of(")"),")")
  derReg <- rex::rex("Derivative(",capture("A",or(1:4), "last"), ",",any_spaces, capture(except_any_of(")")), ")")
  derReg2 <- rex::rex("Derivative(",capture("A1last"), ",",any_spaces, 
                      capture(or(c("b2","r2","k20"))), ")")
  rep <- paste0("\\1",extra)
  doIt <- function(extra=TRUE) {
    ret <- sapply(c("A1","A2","A3","A4"), function(var) {
      .var <- s[[var]]
      if (!is.null(.var)) {
        .var <- as.character(.var)
        if (extra) {
          .var2 <- gsub(funReg, rep, .var)
          .tmp <- c(paste0(var,"=", .var),
                    sapply(get(".args", globalenv()),function(extra){
                      if (var == "A1" && any(extra == c("k20","r2","b2"))){
                        return(NULL)
                      }
                      .d <- D(S(.var2),extra)
                      .d <- gsub(funReg2, "\\1", .d)
                      .d <- gsub(derReg2, "0", .d, perl=TRUE)
                      .d <- gsub(derReg, "\\1\\2", .d, perl=TRUE)
                      paste0(var,extra,"=",.d)
                    }))
          .tmp <- .tmp[.tmp != "NULL"]
          paste(.tmp,collapse="\n")
        } else {
          paste0(var,"=",.var)
        }
      } else {
        NULL
      }
    })
    return(unlist(ret))
  }
  modB <- paste(doIt(TRUE), collapse="\n")
  modA <- paste(doIt(FALSE), collapse="\n")
  assign(".modA", modA, globalenv())
  assign(".modB", modB, globalenv())
  modB <- finalC(rxOptExpr(modB))
  modA <- finalC(rxOptExpr(modA))
  message("linCmtA model (opt):\n")
  message(get(".fA", globalenv()))
  message(modA)
  message("}")
  message("\nlinCmtB model (opt):\n")
  message(get(".fB", globalenv()))
  options(RxODE.syntax.allow.ini=FALSE)
  .lhs <- rxModelVars(get(".modB", globalenv()))$lhs
  options(RxODE.syntax.allow.ini=TRUE)
  .i <- 0
  for (.a in paste0("A", 1:4)){
    if (any(.a == .lhs)){
      .i <- .i + 1;
      .lhs <- .lhs[.lhs != .a]
    }
  }
  message(paste(paste0("#define ", .lhs, " A[", seq_along(.lhs) - 1 + .i, "]"), collapse="\n"))
  if (get(".hasAlast", globalenv())) {
    message(paste(paste0("#define ", gsub("A([1-4])","A\\1last",.lhs), " Alast[", seq_along(.lhs) - 1 + .i, "]"), collapse="\n"))
  }
  message(modB)
  message(paste(paste0("#undef ", .lhs), collapse="\n"))
  if (get(".hasAlast", globalenv())) {
    message(paste(paste0("#undef ", gsub("A([1-4])","A\\1last",.lhs)), collapse="\n"))
  }
  message("}")
  return(invisible(NULL))
}

finalC <- function(x){
  paste0(paste(strsplit(gsub("rx([0-9]+)=","double rx\\1=",gsub("rx_expr_","rx", gsub("~","=",gsub("\\b(k[1-4][0-4]|ka|[rb][1-2]|tau|tinf|t)\\b","(*\\1)", x),perl=TRUE))),"\n")[[1]],collapse=";\n"),";")
}

.fun <- c("A1last", "A2last", "A3last", "A4last")
.args <- c("k10")

.fA <- ""
.fB <- ""


fromC <- function(x) {
  gsub(" *[*]([^=\n]*)=","\\1=",gsub("double ","",gsub("[(][*]([^*]+)[)]","\\1", x)), perl=TRUE)
}

.lines <- readLines(devtools::package_file("src/lincmt.c"))

getFun <- function(x="oneCmtKaRateSSr1"){
  .w <- which(regexpr(paste0("void ", x, " *[(]"), .lines) != -1)[1]
  .l <- .lines[-seq(1, .w - 1)];
  .w <- which(regexpr("}", .l) != -1)[1]
  .l <- .l[seq(1, .w)]
  .l <- gsub("\t", " ", .l)
  while (length(grep("[{]", .l[1])) == 0L) {
    .l[2] <- paste(.l[1:2], collapse=" ")
    .l <- .l[-1]
  }
  .args <- strsplit(gsub(",", " ", gsub("double *[*]", " ", gsub(".*[(]([^)]*)[)].*", "\\1", .l[1]))), " +")[[1]]
  .args <- .args[.args != ""]
  .args <- .args[.args != "A"]
  .hasAlast <- any(.args == "Alast")
  .args <- .args[.args != "Alast"]
  .args2 <- .args[.args != "tinf"]
  .args2 <- .args2[.args2 != "tau"]
  .args2 <- .args2[.args2 != "r1"]
  .args2 <- .args2[.args2 != "r2"]
  .args2 <- .args2[.args2 != "b1"]
  .args2 <- .args2[.args2 != "b2"]
  .args2 <- .args2[.args2 != "t"]
  if (any(.args2 == "ka")){
      .args2 <- c(.args2, c("r1", "b1", "r2", "b2"))
  } else {
      .args2 <- c(.args2, c("r1", "b1"))
  }
  
  assign(".args", .args2, globalenv())
  .l <- .l[-1]
  .l <- paste(.l[-length(.l)], collapse="\n");
  .l <- fromC(.l)
  assign(".hasAlast", .hasAlast, globalenv());
  if (.hasAlast){
    .fargs <- c("A", "Alast", .args)
  } else {
    .fargs <- c("A", .args)
  }
  .fargs <- paste0("(double *", paste(.fargs, collapse=", double *"), ")")
  .fA <- paste0("static inline void ", x, .fargs, " {")
  .fB <- paste0("static inline void ", x, "D", .fargs, " {")
  assign(".fA", .fA, globalenv())
  assign(".fB", .fB, globalenv())
  toC(.l)
  return(invisible(NULL))
}

library(symengine)
library(RxODE)
##devtools::load_all()
```

# One Compartment Sensitivities

## One compartment steady state infusion (Infusion to steady state)


```{r}
getFun("oneCmtRateSSr1")
```

## One compartment steady state infusion (Infusion Tau)

```{r}
getFun("oneCmtRateSS")
```

## One compartment with during infusion

```{r}
getFun("oneCmtRate")
```

## One Compartment Steady State (tau)


```{r}
getFun("oneCmtBolusSS")
```

## One Compartment Model (IV bolus)

```{r}
getFun("oneCmtBolus")
```

## One Compartment Oral Steady state Rate

```{r}
getFun("oneCmtKaRateSSr1")
```

## One compartment Oral Steady State Rate -- depot (tau rate)

```{r}
getFun("oneCmtKaRateSSr2")
```


## One compartment Oral Steady State Rate -- depot (tau rate)

```{r}
getFun("oneCmtKaRateSStr1")
```

## One compartment Oral Steady State Rate -- central (tau rate)

```{r}
getFun("oneCmtKaRateSStr2")
```

## One compartment Oral with Rates

```{r}
getFun("oneCmtKaRate")
```

## One Compartment Oral Ka Steady state bolus #1 senstivities

```{r}
getFun("oneCmtKaSSb1")
```

## One Compartment Oral Ka Steady State Bolus #2 Senstivities

```{r}
getFun("oneCmtKaSSb2")
```

## One Compartment Oral

```{r}
getFun("oneCmtKa")
```
