---
title: "Sensitivities in ADVAN solutions"
output: html_notebook
---

# Helper functions

```{r}
toC <- function(x) {
  s <- rxS(x)
  funReg <- rex::rex(capture(or(get(".fun",globalenv()))))
  extra <- paste0("(",paste(get(".args", globalenv()), collapse = ","),")")
  funReg2 <- rex::rex(capture(funReg),"(",except_any_of(")"),")")
  derReg <- rex::rex("Derivative(",capture("A",or(1:4), "last"), ",",any_spaces, capture(except_any_of(")")), ")")
  rep <- paste0("\\1",extra)
  doIt <- function(extra=TRUE) {
    ret <- sapply(c("A1","A2","A3","A4"), function(var) {
      .var <- s[[var]]
      if (!is.null(.var)) {
        .var <- as.character(.var)
        if (extra) {
          .var2 <- gsub(funReg, rep, .var)
          .tmp <- c(paste0(var,"=", .var),
                    sapply(get(".args", globalenv()),function(extra){
                      if (var == "A1" && any(extra == c("k20","r2","b2"))){
                        return(NULL)
                      }
                      .d <- D(S(.var2),extra)
                      .d <- gsub(funReg2, "\\1", .d)
                      .d <- gsub(derReg, "\\1\\2", .d, perl=TRUE)
                      paste0(var,extra,"=",.d)
                    }))
          .tmp <- .tmp[.tmp != "NULL"]
          paste(.tmp,collapse="\n")
        } else {
          paste0(var,"=",.var)
        }
      } else {
        NULL
      }
    })
    return(unlist(ret))
  }
  modB <- paste(doIt(TRUE), collapse="\n")
  modA <- paste(doIt(FALSE), collapse="\n")
  assign(".modA", modA, globalenv())
  assign(".modB", modB, globalenv())
  modB <- finalC(rxOptExpr(modB))
  modA <- finalC(rxOptExpr(modA))
  message("linCmtA model (opt):\n")
  message(modA)
  message("\nlinCmtB model (opt):\n")
  message(modB)
  return(invisible(NULL))
}

finalC <- function(x){
  paste0(paste(strsplit(gsub("rx([0-9]+)=","double rx\\1=",gsub("rx_expr_","rx", gsub("~","=",gsub("([A][A-Za-z0-9]*)=","*\\1=",gsub("\\b(k[1-4][0-4]|ka|[rb][1-2]|tau|tinf|t|A[1-4]last(|ka|k20|k10|r[1-2|b[1-2])|A[1-4]k[1-4][0-4]last)\\b","(*\\1)", x),perl=TRUE)))),"\n")[[1]],collapse=";\n"),";")
}

.fun <- c("eT","A1last")
.args <- c("k10")

fromC <- function(x) {
       gsub(" *[*]([^=\n]*)=","\\1=",gsub("double ","",gsub("[(][*]([^*]+)[)]","\\1", x)), perl=TRUE)
}
library(symengine)
library(RxODE)
```

# One Compartment Sensitivities

## One compartment steady state infusion (Infusion to steady state)


```{r}
toC(fromC("*A1=(*r1)/(*k10)"))
```

## One compartment steady state infusion (Infusion Tau)

```{r}

.fun <- c("A1last")
.args <- c("k10", "b1", "r1")

message(toC(fromC("
  double eiK = exp(-(*k10)*(*tinf));
  double eK = exp(-(*k10)*((*tau)-(*tinf)))/(1.0-exp(-(*k10)*(*tau)));
  *A1=(*r1)*(1-eiK)*eK/((*k10));
                  ")))
```

## One compartment with during infusion

```{r}

.fun <- c("A1last")
.args <- c("k10", "b1", "r1")
toC(fromC("  double eT = exp(-(*k10)*(*t));
  *A1 = (*r1)/(*k10)*(1-eT)+(*A1last)*eT + (*b1);"))

```

## One Compartment Steady State (tau)


```{r}
toC(fromC("
  double eT = 1.0/(1.0-exp(-(*k10)*(*tau)));
  *A1 = (*b1)*eT;"))
```

## One Compartment Model (IV bolus)

```{r}
toC(fromC("  *A1 = (*A1last)*exp(-(*k10)*(*t)) + (*b1);"))
```

## One Compartment Oral Steady state Rate

```{r}
.fun <- c("A1last","A2last")
.args <- c("ka", "k20", "b1", "r1", "b2", "r2")

toC(fromC("  *A1 = (*r1)/(*ka);
  *A2 = (*r1)/(*k20);"))

message("\n\nr2:\n\n")

toC(fromC("  *A1 = 0;
  *A2 = (*r2)/(*k20);"))
```

## One compartment Oral Steady State Rate -- depot (tau rate)

```{r}

toC(fromC("double eKa = exp(-(*ka)*((*tau)-(*tinf)))/(1.0-exp(-(*tau)*(*ka)));
  double eiKa = exp(-(*ka)*(*tinf));
  double eiK = exp(-(*k20)*(*tinf));
  double eK = exp(-(*k20)*((*tau)-(*tinf)))/(1.0-exp(-(*tau)*(*k20)));
  *A1=eKa*((*r1)/(*ka) - eiKa*(*r1)/(*ka));
  *A2=eK*((*r1)/(*k20) + eiKa*(*r1)/(-(*k20) + (*ka)) - eiK*(*r1)*(*ka)/((*ka)*(*k20) - (*k20)*(*k20))) + (*ka)*(eK - eKa)*((*r1)/(*ka) - eiKa*(*r1)/(*ka))/(-(*k20) + (*ka));"))
```


## One compartment Oral Steady State Rate -- central (tau rate)

```{r}
toC(fromC("  double eiK = exp(-(*k20)*(*tinf));
  double eK = exp(-(*k20)*((*tau)-(*tinf)))/(1.0-exp(-(*k20)*(*tau)));
  *A1=0.0;
  *A2=eK*((*r2)/(*k20) - eiK*(*r2)*(-(*k20) + (*ka))/((*ka)*(*k20) - (*k20)*(*k20)));"))
```

## One compartment Oral with Rates

```{r}
toC(fromC("double eKa = exp(-(*ka)*(*t));
  double e20 = exp(-(*k20)*(*t));
  *A1 = (*r1)/(*ka)-(((*r1)-(*A1last)*(*ka))*eKa)/(*ka) + (*b1);
  *A2 = (((*r1)-(*A1last)*(*ka))*eKa)/((*ka)-(*k20)) - ((((*ka)-(*k20))*(*r2)+(*ka)*(*r1)+(-(*A2last)-(*A1last))*(*k20)*(*ka)+(*A2last)*(*k20)*(*k20))*e20)/((*k20)*(*ka)-(*k20)*(*k20))+ ((*r2)+(*r1))/(*k20) + (*b2);"))
```

## One Compartment Oral Ka Steady state bolus #1 senstivities

```{r}
.fun <- c("eKa", "eK", "A1last", "A2last")
.args <- c("ka", "k20")

message("double eKad=",toC(D(S(fromC("1.0/(1.0-exp(-(*tau)*(*ka)))")),"ka")))
message("double eKd=", toC(D(S(fromC("1.0/(1.0-exp(-(*tau)*(*k20)))")),"k20")))
message("*A1ka=",toC(D(S(fromC("eKa*(*b1)")), "ka")))
A2 <- "(*ka)*(*b1)*(eK - eKa)/(-(*k20) + (*ka))"
message("*A2ka=",toC(D(S(fromC(A2)), "ka")))
message("*A2k20=",toC(D(S(fromC(A2)), "k20")))
```

## One Compartment Oral Ka Steady State Bolus #2 Senstivities

```{r}
.fun <- c("eKa", "eK", "A1last", "A2last")
.args <- c("ka", "k20")

message("double eKd=", toC(D(S(fromC("1.0/(1.0-exp(-(*tau)*(*k20)))")),"k20")))
A2 <- "eK*(*b2)"
message("*A2ka=",toC(D(S(fromC(A2)), "ka")))
message("*A2k20=",toC(D(S(fromC(A2)), "k20")))

```
