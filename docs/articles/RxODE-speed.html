<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Speeding up RxODE â€¢ RxODE</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>


<!-- docsearch -->
<script src="../docsearch.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous" />
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>



<meta property="og:title" content="Speeding up RxODE" />
<meta property="og:description" content="RxODE" />
<meta property="og:image" content="https://nlmixrdevelopment.github.io/RxODE/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RxODE</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="divider"></li>
    <li class="dropdown-header">Getting started</li>
    <li>
      <a href="../articles/RxODE-intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/RxODE-syntax.html">RxODE mini language syntax</a>
    </li>
    <li>
      <a href="../articles/RxODE-pipeline.html">RxODE with piping ie %&gt;%</a>
    </li>
    <li>
      <a href="../articles/RxODE-speed.html">Speeding up RxODE ODE solving</a>
    </li>
    <li>
      <a href="../articles/RxODE-data-frame.html">Adaptive Data Frames with RxODE</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Advanced Features, Model Types, Technical Details</li>
    <li>
      <a href="../articles/RxODE-model-types.html">RxODE model types</a>
    </li>
    <li>
      <a href="../articles/RxODE-cmt.html">Chainging RxODE compartment numbers</a>
    </li>
    <li>
      <a href="../articles/RxODE-transit-compartments.html">RxODE transit compartment models</a>
    </li>
    <li>
      <a href="../articles/RxODE-shiny.html">Using Shiny with RxODE</a>
    </li>
    <li>
      <a href="../articles/RxODE-covariates.html">RxODE covariates</a>
    </li>
    <li>
      <a href="../articles/RxODE-stiff.html">Stiff Systems and Jacobian specification</a>
    </li>
    <li>
      <a href="../articles/RxODE-rxUse.html">Adding compiled RxODE models to your package</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-stethoscope"></span>
     
    Dosing/Events
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/RxODE-event-types.html">Supported Event Types</a>
    </li>
    <li>
      <a href="../articles/RxODE-event-table.html">Easy RxODE Event Tables</a>
    </li>
    <li>
      <a href="../articles/RxODE-events-classic.html">Classic RxODE events explained</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-desktop"></span>
     
    Simulations
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/rxode-single-subject.html">Single Subject ODE solving</a>
    </li>
    <li>
      <a href="../articles/RxODE-sim-var.html">Multiple Subject RxODE Simulation</a>
    </li>
    <li>
      <a href="../articles/RxODE-prior-data.html">Using Prior Data for ODE solving</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-life-ring"></span>
     
    Help
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/RxODE-tutorials.html">Running the interactive tutorials</a>
    </li>
    <li>
      <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4728294/pdf/PSP4-5-03.pdf">2015 CPT tutorial</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="../articles/RxODE-covariates.html">Adding Circadian Rythmn (time-varying covariates)</a>
    </li>
    <li>
      <a href="../articles/RxODE-wt.html">Weight Based Dosing</a>
    </li>
    <li>
      <a href="../articles/RxODE-nesting.html">Simulating Multiple levels of nesting (iov, between study etc)</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://nlmixrdevelopment.github.io/RxODE/reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Functions
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-archive"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="https://nlmixrdevelopment.github.io/nlmixr/">nlmixr</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/nlmixrdevelopment/RxODE">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/nlmixrdevelopment/RxODE/releases">
    <span class="fa fa-download"></span>
     
  </a>
</li>
      </ul>
      
      <form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
        </div>
      </form>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<script src="RxODE-speed_files/header-attrs-2.5/header-attrs.js"></script>
<script src="RxODE-speed_files/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="RxODE-speed_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="RxODE-speed_files/anchor-sections-1.0/anchor-sections.js"></script>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Speeding up RxODE</h1>
                        <h4 class="author">Matthew Fidler</h4>
            
            <h4 class="date">2020-12-01</h4>
      
      <small class="dont-index">Source: <a href='https://github.com/nlmixrdevelopment/RxODE/blob/master/vignettes/RxODE-speed.Rmd'><code>vignettes/RxODE-speed.Rmd</code></a></small>
      <div class="hidden name"><code>RxODE-speed.Rmd</code></div>

    </div>

    
    
<div id="increasing-rxode-speed-by-multi-subject-parallel-solving" class="section level1">
<h1>Increasing RxODE speed by multi-subject parallel solving</h1>
<p><code>RxODE</code> originally developed as an ODE solver that allowed an ODE solve for a single subject. This flexibility is still supported.</p>
<p>The original code from the <code>RxODE</code> tutorial is below:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">library</span>(RxODE)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co">#&gt; RxODE 1.0.0.0 using 4 threads (see ?getRxThreads)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">library</span>(microbenchmark)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="kw">library</span>(mvnfast)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>mod1 &lt;-<span class="st"> </span><span class="kw">RxODE</span>({</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>    C2 =<span class="st"> </span>centr<span class="op">/</span>V2;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>    C3 =<span class="st"> </span>peri<span class="op">/</span>V3;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>    d<span class="op">/</span><span class="kw">dt</span>(depot) =<span class="st"> </span><span class="op">-</span>KA<span class="op">*</span>depot;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>    d<span class="op">/</span><span class="kw">dt</span>(centr) =<span class="st"> </span>KA<span class="op">*</span>depot <span class="op">-</span><span class="st"> </span>CL<span class="op">*</span>C2 <span class="op">-</span><span class="st"> </span>Q<span class="op">*</span>C2 <span class="op">+</span><span class="st"> </span>Q<span class="op">*</span>C3;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>    d<span class="op">/</span><span class="kw">dt</span>(peri) =<span class="st"> </span>Q<span class="op">*</span>C2 <span class="op">-</span><span class="st"> </span>Q<span class="op">*</span>C3;</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>    d<span class="op">/</span><span class="kw">dt</span>(eff) =<span class="st"> </span>Kin <span class="op">-</span><span class="st"> </span>Kout<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>C2<span class="op">/</span>(EC50<span class="op">+</span>C2))<span class="op">*</span>eff;</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>    <span class="kw">eff</span>(<span class="dv">0</span>) =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>})</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="co">#&gt; qs v0.23.4.</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="co">## Create an event table</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a>ev &lt;-<span class="st"> </span><span class="kw">et</span>() <span class="op">%&gt;%</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a><span class="st">    </span><span class="kw">et</span>(<span class="dt">amt=</span><span class="dv">10000</span>, <span class="dt">addl=</span><span class="dv">9</span>,<span class="dt">ii=</span><span class="dv">12</span>) <span class="op">%&gt;%</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a><span class="st">    </span><span class="kw">et</span>(<span class="dt">time=</span><span class="dv">120</span>, <span class="dt">amt=</span><span class="dv">20000</span>, <span class="dt">addl=</span><span class="dv">4</span>, <span class="dt">ii=</span><span class="dv">24</span>) <span class="op">%&gt;%</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a><span class="st">    </span><span class="kw">et</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">240</span>) <span class="co">## Add Sampling</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a>nsub &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># 1000 subproblems</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a>sigma &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">0.09</span>,<span class="fl">0.08</span>,<span class="fl">0.08</span>,<span class="fl">0.25</span>),<span class="dv">2</span>,<span class="dv">2</span>) <span class="co"># IIV covariance matrix</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a>mv &lt;-<span class="st"> </span><span class="kw">rmvn</span>(<span class="dt">n=</span>nsub, <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">2</span>), sigma) <span class="co"># Sample from covariance matrix</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a>CL &lt;-<span class="st"> </span><span class="dv">7</span><span class="op">*</span><span class="kw">exp</span>(mv[,<span class="dv">1</span>])</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a>V2 &lt;-<span class="st"> </span><span class="dv">40</span><span class="op">*</span><span class="kw">exp</span>(mv[,<span class="dv">2</span>])</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a>params.all &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">KA=</span><span class="fl">0.3</span>, <span class="dt">CL=</span>CL, <span class="dt">V2=</span>V2, <span class="dt">Q=</span><span class="dv">10</span>, <span class="dt">V3=</span><span class="dv">300</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a>                    <span class="dt">Kin=</span><span class="fl">0.2</span>, <span class="dt">Kout=</span><span class="fl">0.2</span>, <span class="dt">EC50=</span><span class="dv">8</span>)</span></code></pre></div>
<div id="for-loop" class="section level2">
<h2>For Loop</h2>
<p>The slowest way to code this is to use a <code>for</code> loop. In this example we will enclose it in a function to compare timing.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>runFor &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>    res &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsub) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>        params &lt;-<span class="st"> </span>params.all[i,]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>        x &lt;-<span class="st"> </span>mod1<span class="op">$</span><span class="kw">solve</span>(params, ev, <span class="dt">cacheEvent=</span><span class="ot">FALSE</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>        <span class="co">##Store results for effect compartment</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>        res &lt;-<span class="st"> </span><span class="kw">cbind</span>(res, x[, <span class="st">&quot;eff&quot;</span>])</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    }</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    <span class="kw">return</span>(res)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="running-with-apply" class="section level2">
<h2>Running with apply</h2>
<p>In general for R, the <code>apply</code> types of functions perform better than a <code>for</code> loop, so the tutorial also suggests this speed enhancement</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>runSapply &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>    res &lt;-<span class="st"> </span><span class="kw">apply</span>(params.all, <span class="dv">1</span>, <span class="cf">function</span>(theta)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>        mod1<span class="op">$</span><span class="kw">run</span>(theta, ev, <span class="dt">cacheEvent=</span><span class="ot">FALSE</span>)[, <span class="st">&quot;eff&quot;</span>])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="run-using-a-single-threaded-solve" class="section level2">
<h2>Run using a single-threaded solve</h2>
<p>You can also have RxODE solve all the subject simultaneously without collecting the results in R, using a single threaded solve.</p>
<p>The data output is slightly different here, but still gives the same information:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>runSingleThread &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="kw">solve</span>(mod1, params.all, ev, <span class="dt">cores=</span><span class="dv">1</span>, <span class="dt">cacheEvent=</span><span class="ot">FALSE</span>)[,<span class="kw">c</span>(<span class="st">&quot;sim.id&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;eff&quot;</span>)]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="run-a-2-threaded-solve" class="section level2">
<h2>Run a 2 threaded solve</h2>
<p>RxODE supports multi-threaded solves, so another option is to have <code>2</code> threads (called <code>cores</code> in the solve options, you can see the options in <code>rxControl()</code> or <code>rxSolve()</code>).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>run2Thread &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    <span class="kw">solve</span>(mod1, params.all, ev, <span class="dt">cores=</span><span class="dv">2</span>, <span class="dt">cacheEvent=</span><span class="ot">FALSE</span>)[,<span class="kw">c</span>(<span class="st">&quot;sim.id&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;eff&quot;</span>)]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="compare-the-times-between-all-the-methods" class="section level2">
<h2>Compare the times between all the methods</h2>
<p>Now the moment of truth, the timings:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>bench &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="kw">runFor</span>(), <span class="kw">runSapply</span>(), <span class="kw">runSingleThread</span>(),<span class="kw">run2Thread</span>())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="kw">print</span>(bench)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co">#&gt; Unit: milliseconds</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="co">#&gt;               expr       min        lq      mean    median        uq      max</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co">#&gt;           runFor() 1560.8299 1701.5406 1986.6415 1759.1905 1815.1688 7626.841</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="co">#&gt;        runSapply() 1383.0515 1440.2987 1743.7664 1518.7217 1616.1202 7185.384</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="co">#&gt;  runSingleThread()  138.5651  155.4538  552.8805  159.0332  571.2498 2893.224</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a><span class="co">#&gt;       run2Thread()  139.1568  153.7232  656.9845  162.4007  987.6649 2906.404</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a><span class="co">#&gt;  neval</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a><span class="co">#&gt;    100</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a><span class="co">#&gt;    100</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a><span class="co">#&gt;    100</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="co">#&gt;    100</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">autoplot</span>(bench)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span></span></code></pre></div>
<p><img src="RxODE-speed_files/figure-html/unnamed-chunk-7-1.png" width="700" /></p>
<p>It is clear that the <strong>largest</strong> jump in performance when using the <code>solve</code> method and providing <em>all</em> the parameters to RxODE to solve without looping over each subject with either a <code>for</code> or a <code>sapply</code>. The number of cores/threads applied to the solve also plays a role in the solving.</p>
<p>We can explore the number of threads further with the following code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>runThread &lt;-<span class="st"> </span><span class="cf">function</span>(n){</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    <span class="kw">solve</span>(mod1, params.all, ev, <span class="dt">cores=</span>n, <span class="dt">cacheEvent=</span><span class="ot">FALSE</span>)[,<span class="kw">c</span>(<span class="st">&quot;sim.id&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;eff&quot;</span>)]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>}</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>bench &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">sprintf</span>(<span class="st">&quot;microbenchmark(%s)&quot;</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>                                     <span class="kw">paste</span>(<span class="kw">paste0</span>(<span class="st">&quot;runThread(&quot;</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">rxCores</span>()),<span class="st">&quot;)&quot;</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>                                           <span class="dt">collapse=</span><span class="st">&quot;,&quot;</span>))))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a><span class="kw">print</span>(bench)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="co">#&gt; Unit: milliseconds</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a><span class="co">#&gt;          expr      min       lq     mean   median       uq       max neval</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a><span class="co">#&gt;  runThread(1) 132.4897 158.1793 245.0027 169.6308 196.8338 2353.3552   100</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a><span class="co">#&gt;  runThread(2) 133.7910 159.1878 266.6262 178.5164 199.3480 2779.6821   100</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a><span class="co">#&gt;  runThread(3) 133.5550 158.5458 182.9744 175.1095 189.3750  406.2192   100</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a><span class="co">#&gt;  runThread(4) 136.1894 161.0607 218.8534 175.7979 195.1590 2307.8112   100</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">autoplot</span>(bench)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span></span></code></pre></div>
<p><img src="RxODE-speed_files/figure-html/unnamed-chunk-9-1.png" width="700" /></p>
<p>There can be a suite spot in speed vs number or cores. The system type (mac, linux, windows and/or processor), complexity of the ODE solving and the number of subjects may affect this arbitrary number of threads. 4 threads is a good number to use without any prior knowledge because most systems these days have at least 4 threads (or 2 processors with 4 threads).</p>
</div>
</div>
<div id="a-real-life-example" class="section level1">
<h1>A real life example</h1>
<p>Before some of the parallel solving was implemented, the fastest way to run <code>RxODE</code> was with <code>lapply</code>. This is how Rik Schoemaker created the data-set for <code>nlmixr</code> comparisons:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">library</span>(RxODE)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">library</span>(data.table)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="co">#Define the RxODE model</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>  ode1 &lt;-<span class="st"> &quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a><span class="st">  d/dt(abs)    = -KA*abs;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="st">  d/dt(centr)  =  KA*abs-(CL/V)*centr;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="st">  C2=centr/V;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a><span class="st">  &quot;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a><span class="co">#Create the RxODE simulation object</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>mod1 &lt;-<span class="st"> </span><span class="kw">RxODE</span>(<span class="dt">model =</span> ode1)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a><span class="co">#Population parameter values on log-scale</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>  paramsl &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">CL =</span> <span class="kw">log</span>(<span class="dv">4</span>),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>               <span class="dt">V =</span> <span class="kw">log</span>(<span class="dv">70</span>),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>               <span class="dt">KA =</span> <span class="kw">log</span>(<span class="dv">1</span>))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a><span class="co">#make 10,000 subjects to sample from:</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>  nsubg &lt;-<span class="st"> </span><span class="dv">2500</span> <span class="co"># subjects per dose</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>  doses &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">120</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>  nsub &lt;-<span class="st"> </span>nsubg <span class="op">*</span><span class="st"> </span><span class="kw">length</span>(doses)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a><span class="co">#IIV of 30% for each parameter</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a>  omega &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(<span class="fl">0.09</span>, <span class="fl">0.09</span>, <span class="fl">0.09</span>))<span class="co"># IIV covariance matrix</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a>  sigma &lt;-<span class="st"> </span><span class="fl">0.2</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a><span class="co">#Sample from the multivariate normal</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a>  <span class="kw">set.seed</span>(<span class="dv">98176247</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a>  <span class="kw">library</span>(MASS)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a>  mv &lt;-</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a><span class="st">    </span><span class="kw">mvrnorm</span>(nsub, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">dim</span>(omega)[<span class="dv">1</span>]), omega) <span class="co"># Sample from covariance matrix</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a><span class="co">#Combine population parameters with IIV</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a>  params.all &lt;-</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a><span class="st">    </span><span class="kw">data.table</span>(</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a>      <span class="st">&quot;ID&quot;</span> =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span><span class="op">:</span>nsub),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a>      <span class="st">&quot;CL&quot;</span> =<span class="st"> </span><span class="kw">exp</span>(paramsl[<span class="st">&#39;CL&#39;</span>] <span class="op">+</span><span class="st"> </span>mv[, <span class="dv">1</span>]),</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a>      <span class="st">&quot;V&quot;</span> =<span class="st"> </span><span class="kw">exp</span>(paramsl[<span class="st">&#39;V&#39;</span>] <span class="op">+</span><span class="st"> </span>mv[, <span class="dv">2</span>]),</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a>      <span class="st">&quot;KA&quot;</span> =<span class="st"> </span><span class="kw">exp</span>(paramsl[<span class="st">&#39;KA&#39;</span>] <span class="op">+</span><span class="st"> </span>mv[, <span class="dv">3</span>])</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a>    )</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a><span class="co">#set the doses (looping through the 4 doses)</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true"></a>params.all[, AMT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">rep</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>doses,nsubg)]</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true"></a>Startlapply &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true"></a>  </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true"></a><span class="co">#Run the simulations using lapply for speed</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true"></a>  s =<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>nsub, <span class="cf">function</span>(i) {</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true"></a><span class="co">#selects the parameters associated with the subject to be simulated</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true"></a>    params &lt;-<span class="st"> </span>params.all[i]</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true"></a><span class="co">#creates an eventTable with 7 doses every 24 hours</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true"></a>    ev &lt;-<span class="st"> </span><span class="kw">eventTable</span>()</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true"></a>    ev<span class="op">$</span><span class="kw">add.dosing</span>(</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true"></a>      <span class="dt">dose =</span> params<span class="op">$</span>AMT,</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true"></a>      <span class="dt">nbr.doses =</span> <span class="dv">1</span>,</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true"></a>      <span class="dt">dosing.to =</span> <span class="dv">1</span>,</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true"></a>      <span class="dt">rate =</span> <span class="ot">NULL</span>,</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true"></a>      <span class="dt">start.time =</span> <span class="dv">0</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true"></a>    )</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true"></a><span class="co">#generates 4 random samples in a 24 hour period</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true"></a>    ev<span class="op">$</span><span class="kw">add.sampling</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">sort</span>(<span class="kw">round</span>(<span class="kw">sample</span>(<span class="kw">runif</span>(<span class="dv">600</span>, <span class="dv">0</span>, <span class="dv">1440</span>), <span class="dv">4</span>) <span class="op">/</span><span class="st"> </span><span class="dv">60</span>, <span class="dv">2</span>))))</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true"></a><span class="co">#runs the RxODE simulation</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(mod1<span class="op">$</span><span class="kw">run</span>(params, ev))</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true"></a><span class="co">#merges the parameters and ID number to the simulation output</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true"></a>    x[, <span class="kw">names</span>(params) <span class="op">:</span><span class="er">=</span><span class="st"> </span>params]</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true"></a>  })</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true"></a>  </span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true"></a><span class="co">#runs the entire sequence of 10000 subjects and binds the results to the object res</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true"></a>  res =<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, s))</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true"></a>  </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true"></a>Stoplapply &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true"></a>  </span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true"></a><span class="kw">print</span>(Stoplapply <span class="op">-</span><span class="st"> </span>Startlapply)</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true"></a><span class="co">#&gt; Time difference of 52.60168 secs</span></span></code></pre></div>
<p>By applying some of the new parallel solving concepts you can simply run the same simulation both with less code and faster:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>rx &lt;-<span class="st"> </span><span class="kw">RxODE</span>({</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>    CL =<span class="st">  </span><span class="kw">log</span>(<span class="dv">4</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>    V =<span class="st"> </span><span class="kw">log</span>(<span class="dv">70</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>    KA =<span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>    CL =<span class="st"> </span><span class="kw">exp</span>(CL <span class="op">+</span><span class="st"> </span>eta.CL)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>    V =<span class="st"> </span><span class="kw">exp</span>(V <span class="op">+</span><span class="st"> </span>eta.V)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>    KA =<span class="st"> </span><span class="kw">exp</span>(KA <span class="op">+</span><span class="st"> </span>eta.KA)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>    d<span class="op">/</span><span class="kw">dt</span>(abs)    =<span class="st"> </span><span class="op">-</span>KA<span class="op">*</span>abs;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>    d<span class="op">/</span><span class="kw">dt</span>(centr)  =<span class="st">  </span>KA<span class="op">*</span>abs<span class="op">-</span>(CL<span class="op">/</span>V)<span class="op">*</span>centr;</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>    C2=centr<span class="op">/</span>V;</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>})</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>omega &lt;-<span class="st"> </span><span class="kw">lotri</span>(eta.CL <span class="op">~</span><span class="st"> </span><span class="fl">0.09</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>               eta.V <span class="op">~</span><span class="st"> </span><span class="fl">0.09</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>               eta.KA <span class="op">~</span><span class="st"> </span><span class="fl">0.09</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a>doses &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">120</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a>startParallel &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a>ev &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a>        <span class="kw">lapply</span>(<span class="kw">seq_along</span>(doses), <span class="cf">function</span>(i){</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a>            <span class="kw">et</span>() <span class="op">%&gt;%</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true"></a><span class="st">                </span><span class="kw">et</span>(<span class="dt">amt=</span>doses[i]) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Add single dose</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true"></a><span class="st">                </span><span class="kw">et</span>(<span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Add 0 observation</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true"></a><span class="st">                </span><span class="co">## Generate 4 samples in 24 hour period</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true"></a><span class="st">                </span><span class="kw">et</span>(<span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="cf">function</span>(...){<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">24</span>)})) <span class="op">%&gt;%</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true"></a><span class="st">                </span><span class="kw">et</span>(<span class="dt">id=</span><span class="kw">seq</span>(<span class="dv">1</span>, nsubg) <span class="op">+</span><span class="st"> </span>(i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>nsubg) <span class="op">%&gt;%</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true"></a><span class="st">                </span><span class="co">## Convert to data frame to skip sorting the data</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true"></a><span class="st">                </span><span class="co">## When binding the data together</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true"></a><span class="st">                </span>as.data.frame </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true"></a>        }))</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true"></a><span class="co">## To better compare, use the same output, that is data.table</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true"></a>res &lt;-<span class="st"> </span><span class="kw">rxSolve</span>(rx, ev, <span class="dt">omega=</span>omega, <span class="dt">returnType=</span><span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true"></a><span class="co">#&gt; [====|====|====|====|====|====|====|====|====|====] 0:00:00</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true"></a>endParallel &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true"></a><span class="kw">print</span>(endParallel <span class="op">-</span><span class="st"> </span>startParallel)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true"></a><span class="co">#&gt; Time difference of 1.504339 secs</span></span></code></pre></div>
<p>You can see a striking time difference between the two methods; A few things to keep in mind:</p>
<ul>
<li><p><code>RxODE</code> uses <code>mvnfast</code> for simulation of <code>eta</code> values. This uses the thread safe sumo random number generator. Therefore the results are expected to be different (also the random samples are taken in a different order which would be different)</p></li>
<li><p>This prior simulation was run in R 3.5, which has a different random number generator so the results in this simulation will be different from the actual nlmixr comparison when using the slower simulation.</p></li>
<li><p>This speed comparison used <code>data.table</code>. <code>RxODE</code> uses <code>data.table</code> internally (when available) try to speed up sorting, so this would be different than installations where <code>data.table</code> is not installed. You can force RxODE to use <code>order()</code> when sorting by using <code>forderForceBase(TRUE)</code>. In this case there is little difference between the two, though in other examples <code>data.table</code>â€™s presence leads to a speed increase (and less likely it could lead to a slowdown).</p></li>
</ul>
<div id="want-more-ways-to-run-multi-subject-simulations" class="section level2">
<h2>Want more ways to run multi-subject simulations</h2>
<p>The version since the tutorial has even more ways to run multi-subject simulations, including adding variability in sampling and dosing times with <code>et()</code> (see <a href="https://nlmixrdevelopment.github.io/RxODE/articles/RxODE-events.html#add-doses-and-samples-within-a-sampling-window">RxODE events</a> for more information), ability to supply both an <code>omega</code> and <code>sigma</code> matrix as well as adding as a <code>thetaMat</code> to R to simulate with uncertainty in the <code>omega</code>, <code>sigma</code> and <code>theta</code> matrices; see <a href="https://nlmixrdevelopment.github.io/RxODE/articles/RxODE-sim-var.html">RxODE simulation vignette</a>.</p>
</div>
<div id="session-information" class="section level2">
<h2>Session Information</h2>
<p>The session information:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">sessionInfo</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="co">#&gt; R version 4.0.3 (2020-10-10)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="co">#&gt; Running under: Pop!_OS 20.10</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a><span class="co">#&gt; locale:</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a><span class="co">#&gt;  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a><span class="co">#&gt;  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="co">#&gt;  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="co">#&gt;  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a><span class="co">#&gt;  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a><span class="co">#&gt; [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a><span class="co">#&gt; [1] MASS_7.3-53          data.table_1.13.2    qs_0.23.4           </span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a><span class="co">#&gt; [4] ggplot2_3.3.2        mvnfast_0.2.5.1      microbenchmark_1.4-7</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a><span class="co">#&gt; [7] RxODE_1.0.0-0       </span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a><span class="co">#&gt;  [1] tidyselect_1.1.0    xfun_0.19           purrr_0.3.4        </span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a><span class="co">#&gt;  [4] colorspace_2.0-0    vctrs_0.3.5         generics_0.1.0     </span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a><span class="co">#&gt;  [7] htmltools_0.5.0     yaml_2.2.1          rlang_0.4.9        </span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a><span class="co">#&gt; [10] pkgdown_1.6.1       pillar_1.4.7        glue_1.4.2         </span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a><span class="co">#&gt; [13] withr_2.3.0         lifecycle_0.2.0     stringr_1.4.0      </span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a><span class="co">#&gt; [16] munsell_0.5.0       gtable_0.3.0        ragg_0.4.0         </span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a><span class="co">#&gt; [19] stringfish_0.14.2   memoise_1.1.0       evaluate_0.14      </span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a><span class="co">#&gt; [22] RApiSerialize_0.1.0 knitr_1.30          sys_3.4            </span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a><span class="co">#&gt; [25] fansi_0.4.1         Rcpp_1.0.5          scales_1.1.1       </span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a><span class="co">#&gt; [28] backports_1.2.0     checkmate_2.0.0     desc_1.2.0         </span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a><span class="co">#&gt; [31] RcppParallel_5.0.2  mime_0.9            farver_2.0.3       </span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a><span class="co">#&gt; [34] systemfonts_0.3.2   fs_1.5.0            textshaping_0.2.1  </span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a><span class="co">#&gt; [37] digest_0.6.27       stringi_1.5.3       lotri_0.2.2        </span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a><span class="co">#&gt; [40] dplyr_1.0.2         grid_4.0.3          rprojroot_2.0.2    </span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true"></a><span class="co">#&gt; [43] cli_2.2.0           tools_4.0.3         magrittr_2.0.1     </span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true"></a><span class="co">#&gt; [46] dparser_0.1.8       tibble_3.0.4        PreciseSums_0.4    </span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true"></a><span class="co">#&gt; [49] crayon_1.3.4        pkgconfig_2.0.3     ellipsis_0.3.1     </span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true"></a><span class="co">#&gt; [52] assertthat_0.2.1    rmarkdown_2.5       R6_2.5.0           </span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true"></a><span class="co">#&gt; [55] units_0.6-7         compiler_4.0.3</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc">
      <h2 data-toc-skip>Contents</h2>
    </nav>
      </div>

</div>



      <footer>
      <div class="copyright">
  <p>Developed by Matthew L. Fidler, Melissa Hallow, Wenping Wang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script>
<script>
  docsearch({
    
    
    apiKey: '038b4d83946a52a95a9f8bdafe822dbe',
    indexName: 'rxode',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>



  </body>
</html>
