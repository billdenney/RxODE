---
title: "RxODE in a pipeline"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RxODE in a pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(RxODE)
```
# Setting up the RxODE model for the pipeline

In this example we will show how to use RxODE in a simple pipeline.

We can start with a model that can be used for the different
simulation workflows that RxODE can handle:

```{r}
Ribba2012 <- RxODE({
    k = 100

    tkde = 0.24
    eta.tkde = 0
    kde ~ tkde*exp(eta.tkde)

    tkpq = 0.0295
    eta.kpq = 0
    kpq ~ tkpq * exp(eta.kpq)

    tkqpp = 0.0031
    eta.kqpp = 0
    kqpp ~ tkqpp * exp(eta.kqpp)

    tlambdap = 0.121
    eta.lambdap = 0
    lambdap ~ tlambdap*exp(eta.lambdap)

    tgamma = 0.729
    eta.gamma = 0
    gamma ~ tgamma*exp(eta.gamma)

    tdeltaqp = 0.00867
    eta.deltaqp = 0
    deltaqp ~ tdeltaqp*exp(eta.deltaqp)

    prop.err <- 0
    pstar <- (pt+q+qp)*(1+prop.err)
    d/dt(c) = -kde * c
    d/dt(pt) = lambdap * pt *(1-pstar/k) + kqpp*qp -
        kpq*pt - gamma*c*kde*pt
    d/dt(q) = kpq*pt -gamma*c*kde*q
    d/dt(qp) = gamma*c*kde*q - kqpp*qp - deltaqp*qp
    ## initial conditions
    tpt0 = 7.13
    eta.pt0 = 0
    pt0 ~ tpt0*exp(eta.pt0)
    tq0 = 41.2
    eta.q0 = 0
    q0 ~ tq0*exp(eta.q0)
    pt(0) = pt0
    q(0) = q0
})
```

This is a tumor growth model described in Ribba 2012. In this case, we
compiled the model into an R object `Ribba2012`, though in an RxODE
simulation pipeline, you do not *have* to assign the compiled model to
any object, though I think it makes sense.

# Simulating one event table

Simulating a single event table is quite simple: 

- You pipe the RxODE simulation object into an event table object by `et()`.  
- When the events are completely specified, you simply solve the ODE system with
`rxSolve()`.
- In this case you can pipe the output to `plot()` to conveniently view the results. 
- Note for the plot we are only selecting the selecting following:
  - `pt` (Proliferative Tissue), 
  - `q` (quiescent tissue) 
  - `qp` (DNA-Damaged quiescent tissue) and 
  - `pstar` (total tumor tissue) 

```{r}
Ribba2012 %>% # Use RxODE
    et(time.units="months") %>% # Pipe to a new event table
    et(amt=1, time=50, until=58, ii=1.5) %>% # Add dosing every 1.5 months
    et(0, 250, by=0.5) %>% # Add some sampling times (not required)
    rxSolve() %>% # Solve the simulation
    plot(pt, q, qp, pstar) # Plot it, plotting the variables of interest
```

# Simulating multiple subjects from a single event table

## Simulating with between subject variability

The next sort of simulation that may be useful is simulating multiple
patients with the same treatments.  In this case, we will use the
`omega` matrix specified by the paper:

```{r}
## Add CVs from paper for individual simulation
## Uses exact formula:

lognCv = function(x){log((x/100)^2+1)}

library(lotri)
## Now create omega matrix
## I'm using lotri to quickly specify names/diagonals
omega <- lotri(eta.pt0 ~ lognCv(94),
               eta.q0 ~ lognCv(54),
               eta.lambdap ~ lognCv(72),
               eta.kqp ~ lognCv(76),
               eta.qpp ~ lognCv(97),
               eta.deltaqp ~ lognCv(115),
               eta.kde ~ lognCv(70))

omega
```

With this information, it is easy to simulate 3 subjects from the
model-based parameters:

```{r}
Ribba2012 %>% # Use RxODE
    et(time.units="months") %>% # Pipe to a new event table
    et(amt=1, time=50, until=58, ii=1.5) %>% # Add dosing every 1.5 months
    et(0, 250, by=0.5) %>% # Add some sampling times (not required)
    rxSolve(nSub=3, omega=omega) %>% # Solve the simulation
    plot(pt, q, qp, pstar) # Plot it, plotting the variables of interest

```

Note there are two different things that were added to this simulation: 
- `nSub` to specify how many subjects are in the model
- `omega` to specify the between subject variability.

## Simulation with unexplained variability 

You can even add unexplained variability quite easily:

```{r}
Ribba2012 %>% # Use RxODE
    et(time.units="months") %>% # Pipe to a new event table
    et(amt=1, time=50, until=58, ii=1.5) %>% # Add dosing every 1.5 months
    et(0, 250, by=0.5) %>% # Add some sampling times (not required)
    rxSolve(nSub=3, omega=omega, sigma=lotri(prop.err ~ 0.05^2)) %>% # Solve the simulation
    plot(pt, q, qp, pstar) # Plot it, plotting the variables of interest
```

In this case we only added the `sigma` matrix to have unexplained
variability on the `pstar` or total tumor tissue.

You can even simulate with uncertainty in the `theta` `omega` and `sigma` values if you wish.  
